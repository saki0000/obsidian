---
source:
  - https://medium.com/androiddevelopers/coroutines-on-android-part-i-getting-the-background-3e0e54d20bb#
vault:
  - "[[コルーチンの実装]]"
---
# コルーチンとは
> コルーチンは、非同期処理を簡単に実装するためのもの
### コルーチンが解決する問題
1. 長く実行されるタスクがメイン[[スレッド]]を長くブロックしすぎてしまう
	- APIなどのネットワークリクエストは処理に時間がかかる
	- 長い処理をメインスレッドで行うと、uxが悪くなる
2.  Main-safetyだと、どのsuspend関数もメインスレッドから呼び出せる
	- ネットワークリクエストなどの重い処理をメインスレッドで行うとアプリが重くなる
## 1. 長く実行されるタスク
- APIなどのネットワークリクエストは処理に時間がかかる
- 長い処理をメインスレッドで行うと、uxが悪くなる
### コールバックを使った解決策
ネットワークリクエストを別スレッドで行う方法の一つにコールバックが挙げられる。
- RetrofitもCallbackを用いたライブラリ
```
class ViewModel: ViewModel() {  
	fun fetchDocs() {  
		get("developer.android.com") { result ->  
			show(result)  
		}  
	}  
}
```
上記だと、`get()`はメインスレッドで呼び出されるが、別スレッドを使用してネットワークリクエストを実行する。
その後、結果が返ってくると、メインスレッドでコールバックが呼び出される。
### コルーチンを使った解決策
> コルーチンは、以下の２つの新しい操作を加えた通常の関数に基づいている。
- __suspend__ : 全てのローカル変数を保存して、現在のコルーチンの実行をストップする
- __resume__ : 中断されたコルーチンを、一時停止された場所から継続する
```
// Dispatchers.Main  
suspend fun fetchDocs() {  
    // Dispatchers.Main  
    val result = get("developer.android.com")  
    // Dispatchers.Main  
    show(result)  
}
// look at this in the next section  
suspend fun get(url: String) = withContext(Dispatchers.IO){/*...*/}
```

1. `fetchDocs()`が一時停止する
2. `get()`が一時停止する
3. メインスレッドがフリーになり、他のタスクを実行できるようになる
4. `get()`がresumeする
5. `fetchDocs()`がresumeする

## 2. Main-safety
> コルーチンにおいて、suspend関数は常にメインスレッドから安全に呼び出せる。
- ネットワークリクエストなどの重い処理をメインスレッドで行うとアプリが重くなる
``` note info
`suspend`を使うことはバックグランドスレッドで行うことを指すことではない。指定しなければメインスレッドで実行される
```
メインスレッドにとって重すぎる関数をmain-safetyにするには、コルーチンに`Default`dispatcherか`IO`dispatcherのいずれかで実行されるように指定する。
### CoroutinesとDispatcher
> Kotlinでは、全てのコルーチンはdispatcherで実行される。コルーチンは自身をsuspendできるが、dispatcherがresumeする
- メインスレッドで動作している場合も同様
#### Dispatcher.Main
> Androidにおけるメインスレッドを指す。UIに関することや軽い処理を実行する。
- suspend関数を呼び出す
- UI関数を呼び出す
- LiveDataをアップデートする
#### Dispatchers.IO
> ディスクとインターネットIOを最適化するためのスレッド。
- データベースに関する処理
- ファイルを読み込んだり、書き換えたりする処理
- ネットワークに関する処理
#### Dispatchers.Default
> CPUを使う作業向けに最適化するためのスレッド。
- 配列をソートする
- JSONをパースする
- DiffUtils
#### コード
- `withContext(Dispathcers.IO)`で`IO`dispatcherで実行することを指定している

```
// Dispatchers.Main  
suspend fun fetchDocs() {  
    // Dispatchers.Main  
    val result = get("developer.android.com")  
    // Dispatchers.Main  
    show(result)  
}// Dispatchers.Main  
suspend fun get(url: String) =  
    // Dispatchers.Main  
    withContext(Dispatchers.IO) {  
        // Dispatchers.IO  
	        /* perform blocking network IO here */  
	}  
// Dispatchers.Main
```
### withContext
実行するスレッドを指定できる。
- `withContext`自体がsuspend関数なので、コルーチンを使用してmain-safetyである。
- データベースのアクセスを複数回する場合でも、一回の`withContext`でまとめるよう指定できる
	- その際処理は同じdispatcherで行われる